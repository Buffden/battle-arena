@startuml System Architecture
!define RECTANGLE class
skinparam classAttributeIconSize 0
skinparam linetype ortho

title Battle Arena - Multiplayer Artillery Battle Game - System Architecture

package "Client Layer" #LightBlue {
  [Angular Frontend\nPort: 4200] as Frontend
  note right of Frontend
    **Technologies:**
    - Angular 17+
    - TypeScript
    - TailwindCSS
    - Phaser 3
    
    **Features:**
    - Hero Selection
    - Arena Selection
    - Weapon Selection
    - Game Arena
    - Profile
    - Leaderboard
  end note
}

package "API Gateway Layer" #LightGreen {
  [Nginx Reverse Proxy] as Gateway
}

package "Backend Services" #LightYellow {
  [Auth Service\nPort: 8081\nSpring Boot] as Auth
  [Profile Service\nPort: 8082\nSpring Boot] as Profile
  [Leaderboard Service\nPort: 8083\nSpring Boot] as Leaderboard
  [Matchmaking Service\nPort: 3002\nNode.js] as Matchmaking
  [Game Engine Service\nPort: 5002\nNode.js] as GameEngine
  [Configuration Service\nPort: 8084\nSpring Boot] as Config
  
  note right of Auth
    **Responsibilities:**
    - User authentication
    - JWT token generation
    - Password hashing
    - Session management
  end note
  
  note right of Profile
    **Responsibilities:**
    - User profile management
    - Global score tracking (infinite score, no level cap, not per-hero)
    - Rank tier calculation (like Valorant, based on score ranges)
    - Rank change calculation (based on match score)
    - Player statistics (wins, losses, matches played)
  end note
  
  note right of Leaderboard
    **Responsibilities:**
    - Leaderboard generation (based on global score, end results not in-game scores)
    - Filtering (region, hero type, win%, weapons)
    - Rank tier calculation (score ranges determine rank tiers)
    - Statistics aggregation
    - Players with similar ranks can be in top 5, then global score determines rankings
  end note
  
  note right of Matchmaking
    **Responsibilities:**
    - Hero selection management (multiple heroes, hero matching, hero assignment)
    - Global score/rank-based matching (queue expansion after 5 min)
    - Arena selection (voting/elimination, like CS2 premium matchmaking)
    - Weapon selection (10 weapons per player = 20 total, alternating, 30s total timer)
    - Queue management (hero-based queues, estimated wait time)
    - Lobby creation and management
    - Match acceptance/rejection
    - Reconnection handling (1 min rejoin window)
  end note
  
  note right of GameEngine
    **Responsibilities:**
    - Game room management
    - Real-time game state
    - Turn management (15s/turn, 10 turns per player = 20 total, 4-5min match timer)
    - Movement system (4 moves per game, left/right only)
    - Physics calculations (Matter.js, arena-specific gravity, no wind)
    - Scoring system (accuracy, back-to-back hits, repositioning saves)
    - Health system (hero-specific HP, balanced when matched)
    - Win conditions (HP = 0 = instant loss, OR higher HP at match end)
    - Draw conditions (same HP AND same score)
    - Weapon synergies (dynamic system)
    - Match result processing
  end note
  
  note right of Config
    **Responsibilities:**
    - Configuration file management
    - Rank tier ranges (config files)
    - Scoring formulas (config files)
    - Game parameters (config files)
    - Penalties (config files)
    - Serve configurations to services
    - Note: Hero/Weapon/Arena data stored in MongoDB
  end note
}

package "Data Layer" #LightCoral {
  database "MongoDB\nPort: 27017" as MongoDB
  database "Redis\nPort: 6379" as Redis
  
  note right of MongoDB
    **Collections:**
    - Users
    - Profiles
    - Matches
    - Leaderboard
    - Heroes
    - Weapons
    - Arenas
  end note
  
  note right of Redis
    **Data Structures:**
    - Matchmaking queue (hero-based)
    - Lobby storage
    - Arena/Weapon selection
    - Game state cache
    - Hero/Weapon/Arena config cache
  end note
}

Frontend --> Gateway : HTTPS/WSS
Gateway --> Auth : HTTP
Gateway --> Profile : HTTP
Gateway --> Leaderboard : HTTP
Gateway --> Matchmaking : WebSocket
Gateway --> GameEngine : WebSocket
Gateway --> Config : HTTP

Auth --> MongoDB : MongoDB Driver
Profile --> MongoDB : MongoDB Driver
Leaderboard --> MongoDB : MongoDB Driver
Matchmaking --> Redis : Redis Client
Matchmaking --> MongoDB : MongoDB Driver (Heroes, Weapons, Arenas)
GameEngine --> MongoDB : MongoDB Driver
GameEngine --> Redis : Redis Client
Config --> MongoDB : MongoDB Driver (Config Files Metadata)

Profile --> Matchmaking : Score/Rank updates (internal)
GameEngine --> Profile : Match results (HTTP)
GameEngine --> Leaderboard : Match results (HTTP)
Matchmaking --> Config : Get config files (HTTP - rank tiers, scoring formulas)
GameEngine --> Config : Get config files (HTTP - rank tiers, scoring formulas, penalties)
Config --> Redis : Cache config files

@enduml
