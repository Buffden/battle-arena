name: Security Scanning

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-scanning-java:
    name: Dependency Scanning (Java Services)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, profile-service, leaderboard-service]
    defaults:
      run:
        working-directory: backend-services/${{ matrix.service }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: '${{ matrix.service }}'
          path: '.'
          format: 'HTML,JSON'
          args: >
            --failOnCVSS 7
            --enableRetired
        continue-on-error: true
      
      - name: Check dependency check results
        run: |
          if [ "${{ steps.depcheck.outcome }}" != "success" ]; then
            echo "âš ï¸ Dependency check found vulnerabilities above CVSS 7.0 threshold"
            echo "Review the HTML report in artifacts for details."
            echo "Vulnerabilities with CVSS >= 7.0 were detected."
            echo "::error::Critical or High severity vulnerabilities found in ${{ matrix.service }}"
            exit 1
          else
            echo "âœ… Dependency check passed - no critical vulnerabilities found"
          fi
        continue-on-error: false
      
      - name: Upload dependency check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-java-${{ matrix.service }}-${{ github.sha }}
          path: backend-services/${{ matrix.service }}/reports/**
          retention-days: 90
          if-no-files-found: ignore

  dependency-scanning-nodejs:
    name: Dependency Scanning (Node.js Services)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [matchmaking-service, game-engine]
    defaults:
      run:
        working-directory: backend-services/${{ matrix.service }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend-services/${{ matrix.service }}/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f npm-audit-report.json ]; then
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-report.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-report.json)
            
            echo "Vulnerability Summary:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âš ï¸ Critical or High severity vulnerabilities found!"
              echo "Please review and fix vulnerabilities before merging."
              exit 1
            else
              echo "âœ… No critical or high severity vulnerabilities found"
            fi
          else
            echo "Warning: npm audit report not generated"
          fi
        continue-on-error: false
      
      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-nodejs-${{ matrix.service }}-${{ github.sha }}
          path: backend-services/${{ matrix.service }}/npm-audit-report.json
          retention-days: 90
          if-no-files-found: ignore

  dependency-scanning-frontend:
    name: Dependency Scanning (Frontend)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend-service
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend-service/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f npm-audit-report.json ]; then
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-report.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-report.json)
            
            echo "Vulnerability Summary:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âš ï¸ Critical or High severity vulnerabilities found!"
              echo "Please review and fix vulnerabilities before merging."
              exit 1
            else
              echo "âœ… No critical or high severity vulnerabilities found"
            fi
          else
            echo "Warning: npm audit report not generated"
          fi
        continue-on-error: false
      
      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-frontend-${{ github.sha }}
          path: frontend-service/npm-audit-report.json
          retention-days: 90
          if-no-files-found: ignore

  codeql-analysis:
    name: CodeQL Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: ['java', 'javascript']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
      
      - name: Autobuild Java
        if: matrix.language == 'java'
        uses: github/codeql-action/autobuild@v3
      
      - name: Autobuild JavaScript
        if: matrix.language == 'javascript'
        uses: github/codeql-action/autobuild@v3
        env:
          CODEQL_ACTION_BUILD_MODE: manual
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:${{ matrix.language }}'

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install license-checker
        run: npm install -g license-checker
      
      - name: Check Node.js service licenses
        run: |
          echo "Checking licenses for Node.js services..."
          for service in backend-services/matchmaking-service backend-services/game-engine frontend-service; do
            if [ -f "$service/package.json" ]; then
              echo "Checking $service..."
              cd "$service"
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" || echo "License check completed with warnings"
              cd - > /dev/null
            fi
          done
        continue-on-error: true
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Java Services" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Node.js Services" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Analysis (SAST)" >> $GITHUB_STEP_SUMMARY
          echo "- License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports" >> $GITHUB_STEP_SUMMARY
          echo "Security reports are available as artifacts and in the Security tab." >> $GITHUB_STEP_SUMMARY

