name: Security Scanning

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Monday at 00:00 UTC
    - cron: "0 0 * * 1"

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-scanning-java:
    name: Dependency Scanning (Java Services)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, profile-service, leaderboard-service]
    defaults:
      run:
        working-directory: backend-services/${{ matrix.service }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Verify Java installation
        run: |
          java -version
          echo "JAVA_HOME=$JAVA_HOME"
          which java

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@2ba636726705b0f74f126ebeaacaf2ad4600b967
        id: depcheck
        env:
          # Set JAVA_HOME to Docker container's Java path
          # The OWASP Dependency Check Docker container has Java at /opt/jdk
          JAVA_HOME: /opt/jdk
        with:
          project: "${{ matrix.service }}"
          path: "."
          format: "HTML,JSON"
          out: "reports"
          args: >
            --failOnCVSS 7
            --enableRetired
        continue-on-error: true

      - name: Check dependency check results
        if: always()
        run: |
          if [ "${{ steps.depcheck.outcome }}" != "success" ]; then
            echo "âŒ Dependency check found vulnerabilities above CVSS 7.0 threshold"
            echo "Review the HTML report in artifacts for details."
            echo "Vulnerabilities with CVSS >= 7.0 were detected."

            if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.base_ref }}" == "main" ]; then
              # Strict enforcement for main branch - block merges
              echo "::error::Critical or High severity vulnerabilities found in ${{ matrix.service }}"
              echo "Blocking merge to main branch. Update dependencies to fix vulnerabilities."
              exit 1
            else
              # Non-blocking warning for develop branch - allow development to continue
              echo "::warning::Critical or High severity vulnerabilities found in ${{ matrix.service }}"
              echo "This is a warning for develop branch. Fix vulnerabilities before merging to main."
            fi
          else
            echo "âœ… Dependency check passed - no critical vulnerabilities found"
          fi

      - name: Upload dependency check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-java-${{ matrix.service }}-${{ github.sha }}
          path: backend-services/${{ matrix.service }}/reports/**
          retention-days: 90
          if-no-files-found: ignore

  dependency-scanning-nodejs:
    name: Dependency Scanning (Node.js Services)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [matchmaking-service, game-engine]
    defaults:
      run:
        working-directory: backend-services/${{ matrix.service }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend-services/${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run npm audit
        id: npm_audit
        run: |
          # Generate JSON report for parsing (always succeeds even if vulnerabilities found)
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          # Run audit to display full report (exits with code 1 if any vulnerabilities found at moderate+ level)
          npm audit --audit-level=moderate || echo "âš ï¸ Audit found vulnerabilities - checking severity..."

      - name: Check for critical vulnerabilities
        run: |
          if [ -f npm-audit-report.json ]; then
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-report.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-report.json)
            MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-report.json)

            echo "Vulnerability Summary:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            echo "- Moderate: $MODERATE"

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âŒ Critical or High severity vulnerabilities found!"
              echo "Please review and fix vulnerabilities before merging."
              echo "::error::Critical or High severity vulnerabilities found in ${{ matrix.service }}"
              echo "Update dependencies to fix vulnerabilities: npm audit fix"
              exit 1
            elif [ "$MODERATE" -gt 0 ]; then
              echo "âš ï¸ Moderate severity vulnerabilities found (non-blocking)"
              echo "Consider updating dependencies when possible: npm audit fix"
            else
              echo "âœ… No critical or high severity vulnerabilities found"
            fi
          else
            echo "Warning: npm audit report not generated"
          fi

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-nodejs-${{ matrix.service }}-${{ github.sha }}
          path: backend-services/${{ matrix.service }}/npm-audit-report.json
          retention-days: 90
          if-no-files-found: ignore

  dependency-scanning-frontend:
    name: Dependency Scanning (Frontend)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run npm audit
        id: npm_audit
        run: |
          # Generate JSON report for parsing (always succeeds even if vulnerabilities found)
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          # Run audit to display full report (exits with code 1 if any vulnerabilities found at moderate+ level)
          npm audit --audit-level=moderate || echo "âš ï¸ Audit found vulnerabilities - checking severity..."

      - name: Check for critical vulnerabilities
        run: |
          if [ -f npm-audit-report.json ]; then
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit-report.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit-report.json)
            MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit-report.json)

            echo "Vulnerability Summary:"
            echo "- Critical: $CRITICAL"
            echo "- High: $HIGH"
            echo "- Moderate: $MODERATE"

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âŒ Critical or High severity vulnerabilities found!"
              echo "Please review and fix vulnerabilities before merging."
              echo "::error::Critical or High severity vulnerabilities found in frontend"
              echo "Update dependencies to fix vulnerabilities: npm audit fix"
              exit 1
            elif [ "$MODERATE" -gt 0 ]; then
              echo "âš ï¸ Moderate severity vulnerabilities found (non-blocking)"
              echo "Consider updating dependencies when possible: npm audit fix"
            else
              echo "âœ… No critical or high severity vulnerabilities found"
            fi
          else
            echo "Warning: npm audit report not generated"
          fi

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-frontend-${{ github.sha }}
          path: frontend-service/npm-audit-report.json
          retention-days: 90
          if-no-files-found: ignore

  codeql-analysis:
    name: CodeQL Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@014f16e7ab1402f30e7c3329d33797e7948572db
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Set up Java 17
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Verify Java installation
        if: matrix.language == 'java'
        run: |
          java -version
          echo "JAVA_HOME=$JAVA_HOME"
          which java

      - name: Cache Maven dependencies
        if: matrix.language == 'java'
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build Java Services
        if: matrix.language == 'java'
        run: |
          for service in auth-service profile-service leaderboard-service; do
            echo "Building $service..."
            cd backend-services/$service
            # CodeQL only needs compiled code for analysis, tests are run separately in backend-ci
            mvn clean compile || echo "Build failed for $service, continuing..."
            cd - > /dev/null
          done
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@014f16e7ab1402f30e7c3329d33797e7948572db
        with:
          category: "/language:${{ matrix.language }}"
        continue-on-error: true

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check Node.js service licenses
        run: |
          echo "Checking licenses for Node.js services..."
          for service in backend-services/matchmaking-service backend-services/game-engine frontend-service; do
            if [ -f "$service/package.json" ]; then
              echo "Checking $service..."
              cd "$service"
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" || echo "License check completed with warnings"
              cd - > /dev/null
            fi
          done
        continue-on-error: true

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Java Services" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Node.js Services" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Analysis (SAST)" >> $GITHUB_STEP_SUMMARY
          echo "- License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports" >> $GITHUB_STEP_SUMMARY
          echo "Security reports are available as artifacts and in the Security tab." >> $GITHUB_STEP_SUMMARY
