# Battle Arena - Nginx API Gateway Configuration
# This configuration routes requests to backend microservices and handles
# WebSocket connections for real-time game communication.

events {
    # Each worker can handle up to 1,024 concurrent connections.
    worker_connections 1024;
}

# Core HTTP settings and performance tuning.
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # DNS resolver for Docker Compose network (127.0.0.11 is Docker's internal DNS)
    # This allows Nginx to resolve service names dynamically
    # valid=30s: DNS cache expires after 30 seconds (prevents stale IPs)
    # ipv6=off: Disable IPv6 to avoid resolution delays
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Rate limiting zones (for future use)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=5r/s;


    # Upstream Services - Backend Microservices
    # Services are referenced by Docker service names for service discovery
    # Load balancing uses round-robin by default (can be extended)
    # See tech_notes.md for detailed theoretical and industrial best practices
    # Note: Services must exist in Docker network for upstream to resolve

    # Upstream Services - Backend Microservices
    # Using variable-based proxy_pass for dynamic DNS resolution (resolved at request time, not startup)
    # This allows Nginx to start even if services aren't ready yet

    # Auth Service - Stateless REST API (port 8081)
    upstream auth-service {
        server auth-service:8081;
    }

    # Profile Service - Stateless REST API with caching (port 8082)
    upstream profile-service {
        server profile-service:8082;
    }

    # Leaderboard Service - Read-heavy REST API (port 8083)
    upstream leaderboard-service {
        server leaderboard-service:8083;
    }

    # Matchmaking Service - Stateful WebSocket (port 3002)
    # With ip_hash: same client IP always goes to the same instance (sticky sessions) for WebSocket connections
    upstream matchmaking-service {
        ip_hash;
        server matchmaking-service:3002;
    }

    # Game Engine Service - Stateful WebSocket (port 5002)
    # With ip_hash: same client IP always goes to the same instance (sticky sessions) for WebSocket connections
    upstream game-engine {
        ip_hash;
        server game-engine:5002;
    }

    # Frontend Service - Static files and SPA routing (port 80)
    upstream frontend-service {
        server frontend-service:80;
    }

    # HTTP Server Block - Port 80 (Development)
    server {
        listen 80;
        server_name localhost;

        # Client body size limit (for file uploads, etc.)
        client_max_body_size 10M;

        # CORS configuration (for development - restrict in production)
        # CORS headers for all responses (including error responses)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        # Health Check Endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Auth Service Routes - REST API
        # Routes: /api/auth/*
        location /api/auth/ {
            # Handle preflight OPTIONS requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Future: Apply rate limiting
            # limit_req zone=api_limit burst=20 nodelay;

            # Proxy to auth-service without stripping /api/auth prefix
            # AuthController expects /api/auth/login, not /login
            # Use variable-based proxy_pass for dynamic DNS resolution
            set $auth_upstream http://auth-service:8081;
            proxy_pass $auth_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Auth Service root endpoint
        location = /api/auth {
            return 301 /api/auth/;
        }

        # Profile Service Routes - REST API
        # Routes: /api/profile/*
        location /api/profile/ {
            # Handle preflight OPTIONS requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Future: Apply rate limiting
            # limit_req zone=api_limit burst=20 nodelay;

            # Strip /api/profile prefix and proxy to service
            # Use variable-based proxy_pass for dynamic DNS resolution
            rewrite ^/api/profile(/.*)$ $1 break;
            set $profile_upstream http://profile-service:8082;
            proxy_pass $profile_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Profile Service root endpoint
        location = /api/profile {
            return 301 /api/profile/;
        }

        # Leaderboard Service Routes - REST API
        # Routes: /api/leaderboard/*
        location /api/leaderboard/ {
            # Handle preflight OPTIONS requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Future: Apply rate limiting
            # limit_req zone=api_limit burst=20 nodelay;

            # Strip /api/leaderboard prefix and proxy to service
            # Use variable-based proxy_pass for dynamic DNS resolution
            rewrite ^/api/leaderboard(/.*)$ $1 break;
            set $leaderboard_upstream http://leaderboard-service:8083;
            proxy_pass $leaderboard_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Leaderboard Service root endpoint
        location = /api/leaderboard {
            return 301 /api/leaderboard/;
        }

        # Matchmaking Service Routes - WebSocket Support
        # Routes: /ws/matchmaking (WebSocket for hero selection, queue, etc.)
        location /ws/matchmaking {
            # Handle preflight OPTIONS requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Future: Apply rate limiting for WebSocket connections
            # limit_req zone=ws_limit burst=10 nodelay;

            # Use variable-based proxy_pass for dynamic DNS resolution
            # Note: ip_hash sticky sessions require upstream blocks, but we prioritize
            # dynamic DNS resolution to prevent 502 errors on service restarts
            set $matchmaking_upstream http://matchmaking-service:3002;
            proxy_pass $matchmaking_upstream;
            proxy_http_version 1.1;

            # WebSocket upgrade headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket timeouts (longer for persistent connections)
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        # Game Engine Service - WebSocket Support
        # Routes: /ws/game (WebSocket for real-time game communication)
        location /ws/game {
            # Handle preflight OPTIONS requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Future: Apply rate limiting for WebSocket connections
            # limit_req zone=ws_limit burst=10 nodelay;

            # Use variable-based proxy_pass for dynamic DNS resolution
            # Note: ip_hash sticky sessions require upstream blocks, but we prioritize
            # dynamic DNS resolution to prevent 502 errors on service restarts
            set $game_engine_upstream http://game-engine:5002;
            proxy_pass $game_engine_upstream;
            proxy_http_version 1.1;

            # WebSocket upgrade headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket timeouts (longer for persistent connections)
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        # Frontend Service - Static files and SPA routing
        location / {
            # Use variable-based proxy_pass for dynamic DNS resolution
            set $frontend_upstream http://frontend-service:80;
            proxy_pass $frontend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    # HTTPS Server Block - Port 443 (Placeholder for Production)
    # Uncomment and configure when SSL certificates are available
    #
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #
    #     # SSL certificate configuration
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #
    #     # SSL configuration
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #     ssl_prefer_server_ciphers on;
    #     ssl_session_cache shared:SSL:10m;
    #     ssl_session_timeout 10m;
    #
    #     # Same location blocks as HTTP server above
    #     # Copy all location blocks from the HTTP server block
    # }
}
